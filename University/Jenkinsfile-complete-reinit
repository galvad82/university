pipeline {
    agent any
    tools { 
		maven 'mvn' 
		jdk 'jdk11' 
	}
    stages {
        stage('Scan-package') { 
			steps {
				withSonarQubeEnv(credentialsId: 'jenkins-sonar-token', installationName:'sonar'){
					sh '''
					cd ./University
					mvn clean package sonar:sonar -Dstyle.color=never -DskipTests=true
					docker stop university || true && docker rm university || true
					docker rmi university:latest
					docker build -t university . -f ./dockerfiles/Dockerfile
					cd ./dockerfiles
					docker stop keycloak || true && docker rm keycloak || true
					docker stop postgres || true && docker rm postgres || true
					docker image rm jboss/keycloak:latest || (echo "Image jboss/keycloak:latest didn't exist so not removed."; exit 0)
					docker image rm postgres:13.5-alpine || (echo "Image postgres:13.5-alpine didn't exist so not removed."; exit 0)
					/usr/bin/docker-compose up -d
					docker image prune -f
					'''
				}
            }
		}
    }
}
